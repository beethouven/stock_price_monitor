name: Daily Test Run  # âœ… Workflow çš„åç¨±ï¼Œå‡ºç¾åœ¨ GitHub Actions é é¢ä¸Š

on:
  workflow_dispatch:      # ğŸ‘‰ æ‰‹å‹•è§¸ç™¼ï¼ˆActions é é¢é»ã€ŒRun workflowã€ï¼‰

  push:                   # ğŸ‘‰ ç•¶ä½ æœ‰æª”æ¡ˆæ›´æ–°ï¼ˆä¾‹å¦‚ YAML æª”ï¼‰å°±è§¸ç™¼
    paths:
      - '.github/workflows/*.yml'

  schedule:               # ğŸ‘‰ æ¯å¤©æ—©ä¸Šå°ç£æ™‚é–“ 8:30 è‡ªå‹•åŸ·è¡Œ
    - cron: '30 0 * * 1-5'  # UTC æ™‚é–“ 00:30 = å°ç£æ™‚é–“ 08:30

jobs:
  run-test:  # ğŸ§ª Job åç¨±ï¼ˆä½ å¯ä»¥å‘½åç‚ºå…¶ä»–ç”¨é€”ï¼Œä¾‹å¦‚ run-stock-monitorï¼‰

    runs-on: ubuntu-latest  # ğŸ–¥ ä½¿ç”¨ GitHub æä¾›çš„ Ubuntu Runner ä¾†åŸ·è¡Œä»»å‹™

    steps:  # ğŸªœ æ¯å€‹æ­¥é©Ÿä¾åºåŸ·è¡Œ
      - name: Checkout repository
        uses: actions/checkout@v3  # ğŸ“¦ å–å¾—ç›®å‰ repo çš„ç¨‹å¼ç¢¼ï¼Œæº–å‚™åŸ·è¡Œ

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'  # ğŸ è¨­å®šä½¿ç”¨çš„ Python ç‰ˆæœ¬ç‚º 3.10

      - name: Install dependencies
        run: pip install -r requirements.txt  # ğŸ“¥ å®‰è£å¥—ä»¶ï¼ˆä½ åœ¨ requirements.txt è£¡å®šç¾©ï¼‰

      - name: Run test and generate report
        run: python run_test.py  # ğŸš€ åŸ·è¡Œä½ çš„ä¸»è…³æœ¬ï¼Œç”¢ç”Ÿå ±å‘Šèˆ‡ç´€éŒ„

      - name: Set timestamp variable
        id: vars
        run: echo "REPORT_PATH=reports/test_report_$(date +'%Y-%m-%d_%H').html" >> $GITHUB_ENV

      - name: Upload HTML report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: ${{ env.REPORT_PATH }}
          # ğŸ“„ artifact åç¨±èˆ‡è·¯å¾‘ï¼Œä½¿ç”¨ç’°å¢ƒè®Šæ•¸ä¾†å‹•æ…‹è¨­å®š

      - name: Send report via email
        continue-on-error: true            # ğŸ”„ å¦‚æœå¯„é€å¤±æ•—ä¸æœƒä¸­æ–·æ•´å€‹å·¥ä½œæµç¨‹
        uses: dawidd6/action-send-mail@v3  # ğŸ“§ ä½¿ç”¨ç¬¬ä¸‰æ–¹ mail action å¥—ä»¶å¯„å‡ºå ±å‘Š
        with:
          server_address: smtp.gmail.com  # âœ‰ï¸ SMTP ä¼ºæœå™¨åœ°å€ï¼ˆä¾‹å¦‚ Gmail å¯ç”¨ smtp.gmail.comï¼‰
          server_port: 587  # ğŸ” é€šå¸¸ä½¿ç”¨ 587 æˆ– 465ï¼ˆä¾æœå‹™è€Œå®šï¼‰
          username: ${{ secrets.EMAIL_USERNAME }}  # ğŸ‘¤ ç™»å…¥å¸³è™Ÿï¼ˆå¾ Secrets è®€å–ï¼‰
          password: ${{ secrets.GMAIL_APP_PASSWORD }}  # ğŸ”‘ ç™»å…¥å¯†ç¢¼ï¼ˆå»ºè­°ç”¨ App Password æˆ– OAuth Tokenï¼‰
          subject: Daily Test Report  # ğŸ“Œ ä¿¡ä»¶ä¸»é¡Œ
          to: ${{ secrets.EMAIL_USERNAME }}  # ğŸ“¥ æ”¶ä»¶äººä¿¡ç®±
          from: ${{ secrets.EMAIL_USERNAME }}  # ğŸ“¤ å¯„ä»¶äººä¿¡ç®±ï¼ˆå¯èˆ‡ username ä¸€è‡´ï¼‰
          body: "è«‹åƒé–±ä»Šæ—¥æ¸¬è©¦å ±å‘Šï¼ŒHTML æª”æ¡ˆå·²é™„åŠ ã€‚"  # ğŸ“„ ä¿¡ä»¶å…§å®¹
          attachments: ${{ env.REPORT_PATH }}  # ğŸ“ é™„åŠ å ±å‘Šæª”æ¡ˆ

      - name: ä¸Šå‚³æ¸¬è©¦å ±å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: test-report-${{ github.run_id }}
          path: reports/test_report_*.html

      - name: ç•™è¨€å ±å‘Šé€£çµ
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: 1,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "âœ… æ¸¬è©¦å®Œæˆï¼[å ±å‘Šä¸‹è¼‰é»](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})"
            });


      # ç›®å‰ä¸æ”¯æ´ LINE Notify çš„ç›´æ¥å¯„é€
      # å¦‚æœéœ€è¦ï¼Œå¯ä»¥ä½¿ç”¨ curl æˆ–å…¶ä»–å·¥å…·ä¾†å¯¦ç¾
      # - name: Send LINE Notify
      #   run: |
      #     curl -X POST https://notify-api.line.me/api/notify \
      #       -H "Authorization: Bearer ${{ secrets.LINE_NOTIFY_TOKEN }}" \
      #       -F "message=âœ… æ¸¬è©¦å®Œæˆï¼å ±å‘Šå·²å¯„å‡ºï¼Œè«‹æŸ¥çœ‹ä½ çš„ä¿¡ç®±ã€‚"  # ğŸ”” å‚³é€é€šçŸ¥è¨Šæ¯åˆ° LINE

      # æ¥ä¸‹ä¾†å®Œæˆä¸‹é¢çš„éƒ¨åˆ†
      # - name: Telegram fallback if email fails
      #   if: steps.send_email.outcome != 'success'
      #   run: |
      #     curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
      #       -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
      #       -d text="âš ï¸ Email ç™¼é€å¤±æ•—ï¼Œå·²æ”¹ç”± Telegram é€šå ±\næ¸¬è©¦å ±å‘Šï¼š${{ env.REPORT_PATH }}"

      # - name: Append result to Google Sheets (via API)
      #   if: always()
      #   run: python push_google_sheets.py

      # - name: Always upload report as artifact
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: test-report
      #     path: ${{ env.REPORT_PATH }}



